{% extends "base.html" %}
{% load math_filters %}

{% block title %}Result | Skin Disease Detection{% endblock %}

{% block content %}
<style>
  :root {
    --animation-speed: 0.3s;
    --hover-lift: -4px;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes slideInRight {
    from {
      opacity: 0;
      transform: translateX(-30px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  @keyframes scaleIn {
    from {
      opacity: 0;
      transform: scale(0.9);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  @keyframes progressFill {
    from {
      width: 0%;
    }
  }

  @keyframes pulse {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.7;
    }
  }

  @keyframes shimmer {
    to {
      left: 200%;
    }
  }

  .result-container {
    max-width: 100%;
    width: 100%;
    margin: 0 auto;
    padding: 0;
    animation: fadeInUp 0.6s ease-out;
  }

  .result-header {
    background: linear-gradient(135deg, var(--primary-navy) 0%, var(--primary-dark) 100%);
    color: white;
    padding: clamp(1.5rem, 4vw, 2.5rem);
    border-radius: var(--border-radius-xl) var(--border-radius-xl) 0 0;
    text-align: center;
    box-shadow: var(--shadow-card);
    position: relative;
    overflow: hidden;
  }

  .result-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    animation: shimmer 3s infinite;
  }

  .result-header h2 {
    margin: 0 0 0.5rem 0;
    font-size: clamp(1.375rem, 4vw, 1.75rem);
    font-weight: 700;
    position: relative;
    z-index: 1;
  }

  .result-header p {
    margin: 0;
    color: rgba(255, 255, 255, 0.9);
    font-size: clamp(0.875rem, 2.5vw, 1rem);
    position: relative;
    z-index: 1;
  }

  .result-body {
    background: var(--card-bg);
    padding: clamp(1rem, 3vw, 2rem);
    border-radius: 0 0 var(--border-radius-xl) var(--border-radius-xl);
    box-shadow: var(--shadow-card);
  }

  .prediction-card {
    background: linear-gradient(135deg, var(--soft-gray) 0%, rgba(226, 232, 240, 0.5) 100%);
    border: none;
    border-radius: var(--border-radius-lg);
    padding: clamp(1.25rem, 3vw, 2rem);
    margin-bottom: clamp(1rem, 3vw, 2rem);
    animation: scaleIn 0.6s ease-out 0.2s both;
    position: relative;
    overflow: hidden;
    transition: all var(--animation-speed) ease;
  }

  .prediction-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-hover);
  }

  .prediction-title {
    font-size: clamp(0.75rem, 2vw, 0.875rem);
    font-weight: 600;
    color: var(--text-muted);
    margin-bottom: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .disease-name {
    font-size: clamp(1.375rem, 4vw, 2rem);
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 1.5rem;
    word-wrap: break-word;
    line-height: 1.3;
  }

  .confidence-section {
    margin-bottom: 1.5rem;
  }

  .confidence-label {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.75rem;
    display: block;
    font-size: clamp(0.8125rem, 2vw, 0.875rem);
  }

  .animated-progress {
    height: clamp(32px, 8vw, 40px);
    background: var(--light-bg);
    border-radius: var(--border-radius-lg);
    overflow: hidden;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
    position: relative;
    touch-action: none;
  }

  .progress-fill {
    height: 100%;
    border-radius: var(--border-radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: white;
    font-size: clamp(0.875rem, 2.5vw, 1rem);
    transition: all 0.3s ease;
    animation: progressFill 1.5s ease-out;
    position: relative;
    overflow: hidden;
  }

  .progress-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    animation: shimmer 2s infinite;
  }

  .progress-high {
    background: linear-gradient(135deg, var(--accent-green) 0%, #059669 100%);
  }

  .progress-medium {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  }

  .progress-low {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  }

  .severity-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: clamp(0.5rem, 2vw, 0.625rem) clamp(1rem, 3vw, 1.25rem);
    border-radius: var(--border-radius-md);
    font-weight: 600;
    font-size: clamp(0.8125rem, 2.5vw, 0.9375rem);
    box-shadow: var(--shadow-card);
    transition: all var(--animation-speed) ease;
  }

  .severity-badge:hover {
    transform: scale(1.05);
  }

  .severity-high {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
  }

  .severity-medium {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
  }

  .severity-low {
    background: linear-gradient(135deg, var(--accent-green) 0%, #059669 100%);
    color: white;
  }

  .section-card {
    background: var(--card-bg);
    border-radius: var(--border-radius-xl);
    padding: clamp(1.25rem, 3vw, 2rem);
    margin-bottom: clamp(1rem, 3vw, 1.5rem);
    box-shadow: var(--shadow-card);
    border: none;
    animation: fadeInUp 0.6s ease-out;
    transition: all var(--animation-speed) ease;
  }

  .section-card:hover {
    box-shadow: var(--shadow-hover);
    transform: translateY(-2px);
  }

  .section-title {
    font-size: clamp(1.125rem, 3vw, 1.25rem);
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .section-icon {
    font-size: clamp(1.25rem, 3vw, 1.5rem);
  }

  .top-prediction-item {
    background: var(--soft-gray);
    border-radius: var(--border-radius-md);
    padding: clamp(1rem, 2.5vw, 1.25rem);
    margin-bottom: 1rem;
    transition: all var(--animation-speed) ease;
    animation: slideInRight 0.4s ease-out;
    cursor: pointer;
  }

  .top-prediction-item:nth-child(1) {
    animation-delay: 0.1s;
  }

  .top-prediction-item:nth-child(2) {
    animation-delay: 0.2s;
  }

  .top-prediction-item:nth-child(3) {
    animation-delay: 0.3s;
  }

  .top-prediction-item:hover {
    background: var(--card-bg);
    box-shadow: var(--shadow-card);
    transform: translateX(5px) scale(1.02);
  }

  .top-prediction-item:active {
    transform: translateX(3px) scale(0.98);
  }

  .prediction-rank {
    width: clamp(32px, 8vw, 40px);
    height: clamp(32px, 8vw, 40px);
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: white;
    margin-right: clamp(0.75rem, 2vw, 1rem);
    font-size: clamp(0.9375rem, 2.5vw, 1.125rem);
    box-shadow: var(--shadow-card);
    flex-shrink: 0;
  }

  .rank-1 {
    background: linear-gradient(135deg, var(--primary-navy) 0%, var(--primary-dark) 100%);
  }

  .rank-2 {
    background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
  }

  .rank-3 {
    background: linear-gradient(135deg, var(--text-secondary) 0%, #64748b 100%);
  }

  .chart-container {
    background: var(--card-bg);
    border-radius: var(--border-radius-lg);
    padding: clamp(1rem, 2.5vw, 1.5rem);
    box-shadow: var(--shadow-card);
    animation: scaleIn 0.6s ease-out 0.3s both;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .chart-wrapper {
    position: relative;
    width: 100%;
    height: 100%;
    min-height: clamp(200px, 40vw, 280px);
  }

  .info-section {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border-left: 4px solid #3b82f6;
    border-radius: var(--border-radius-lg);
    padding: clamp(1.25rem, 3vw, 2rem);
    margin-bottom: clamp(1rem, 3vw, 1.5rem);
    animation: fadeInUp 0.6s ease-out 0.4s both;
    box-shadow: var(--shadow-card);
  }

  .info-title {
    font-size: clamp(1.125rem, 3vw, 1.25rem);
    font-weight: 700;
    color: #1e40af;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .info-content {
    color: #1e3a8a;
    line-height: 1.7;
    font-size: clamp(0.875rem, 2.5vw, 1rem);
  }

  .info-list {
    list-style: none;
    padding: 0;
  }

  .info-list li {
    padding: 0.625rem 0;
    padding-left: 1.75rem;
    position: relative;
  }

  .info-list li::before {
    content: '‚úì';
    position: absolute;
    left: 0;
    color: #3b82f6;
    font-weight: 700;
    font-size: 1.125rem;
  }

  .treatment-list {
    counter-reset: treatment-counter;
    list-style: none;
    padding: 0;
  }

  .treatment-list li {
    counter-increment: treatment-counter;
    padding: clamp(0.875rem, 2vw, 1rem);
    padding-left: clamp(2.75rem, 7vw, 3rem);
    margin-bottom: 0.75rem;
    background: white;
    border-radius: var(--border-radius-md);
    position: relative;
    animation: slideInRight 0.4s ease-out;
    box-shadow: var(--shadow-card);
    font-size: clamp(0.875rem, 2.5vw, 1rem);
  }

  .treatment-list li::before {
    content: counter(treatment-counter);
    position: absolute;
    left: clamp(0.75rem, 2vw, 1rem);
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, var(--primary-navy) 0%, var(--primary-dark) 100%);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.875rem;
  }

  .warning-box {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border: 2px solid #f59e0b;
    border-radius: var(--border-radius-lg);
    padding: clamp(1.25rem, 3vw, 1.5rem);
    margin: clamp(1rem, 3vw, 1.5rem) 0;
    animation: fadeInUp 0.6s ease-out 0.5s both;
    box-shadow: var(--shadow-card);
  }

  .warning-icon {
    font-size: clamp(1.5rem, 4vw, 2rem);
    margin-bottom: 0.5rem;
    animation: pulse 2s infinite;
  }

  .warning-title {
    font-weight: 700;
    color: #92400e;
    margin-bottom: 0.75rem;
    font-size: clamp(1rem, 2.5vw, 1.125rem);
  }

  .warning-text {
    color: #78350f;
    line-height: 1.6;
    font-size: clamp(0.875rem, 2.5vw, 1rem);
  }

  .action-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: clamp(0.875rem, 2.5vw, 1rem) clamp(1.5rem, 4vw, 2rem);
    background: linear-gradient(135deg, var(--primary-navy) 0%, var(--primary-dark) 100%);
    color: white;
    border-radius: var(--border-radius-md);
    font-weight: 600;
    text-decoration: none;
    transition: all var(--animation-speed) ease;
    box-shadow: var(--shadow-card);
    margin-top: 1rem;
    font-size: clamp(0.875rem, 2.5vw, 1rem);
    width: 100%;
    max-width: 300px;
  }

  .action-button:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-hover);
    color: white;
    background: linear-gradient(135deg, var(--primary-dark) 0%, #0f172a 100%);
  }

  .action-button:active {
    transform: translateY(0);
  }

  .collapsible-section {
    border: none;
    border-radius: var(--border-radius-lg);
    overflow: hidden;
    margin-bottom: 1rem;
    background: var(--soft-gray);
    box-shadow: var(--shadow-card);
    transition: all var(--animation-speed) ease;
  }

  .collapsible-header {
    background: var(--soft-gray);
    padding: clamp(1rem, 2.5vw, 1.25rem) clamp(1.25rem, 3vw, 1.5rem);
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 600;
    color: var(--text-primary);
    transition: all var(--animation-speed) ease;
    font-size: clamp(0.875rem, 2.5vw, 1rem);
    user-select: none;
    -webkit-tap-highlight-color: transparent;
  }

  .collapsible-header:hover {
    background: var(--card-bg);
  }

  .collapsible-header:active {
    transform: scale(0.98);
  }

  .collapsible-icon {
    transition: transform var(--animation-speed) ease;
    color: var(--text-secondary);
    font-size: 1.25rem;
  }

  .collapsible-content {
    padding: 0;
    max-height: 0;
    overflow: hidden;
    background: var(--card-bg);
    transition: all 0.4s ease;
  }

  .collapsible-content.active {
    padding: clamp(1.25rem, 3vw, 1.5rem);
    max-height: 2000px;
  }

  .model-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: linear-gradient(135deg, var(--primary-navy) 0%, var(--primary-dark) 100%);
    color: white;
    padding: clamp(0.5rem, 2vw, 0.5rem) clamp(1rem, 3vw, 1.25rem);
    border-radius: var(--border-radius-md);
    font-size: clamp(0.8125rem, 2vw, 0.875rem);
    font-weight: 600;
    margin-top: 1.5rem;
    box-shadow: var(--shadow-card);
  }

  .image-card {
    border: 2px solid var(--soft-gray);
    border-radius: var(--border-radius-lg);
    overflow: hidden;
    transition: all var(--animation-speed) ease;
    box-shadow: var(--shadow-card);
    height: 100%;
  }

  .image-card:hover {
    box-shadow: var(--shadow-hover);
    transform: translateY(-4px);
  }

  .image-card-header {
    background: linear-gradient(135deg, var(--primary-navy) 0%, var(--primary-dark) 100%);
    color: white;
    padding: clamp(0.875rem, 2vw, 1rem) clamp(1rem, 2.5vw, 1.25rem);
    font-weight: 600;
    font-size: clamp(0.875rem, 2.5vw, 0.9375rem);
  }

  .image-card-body {
    padding: clamp(1rem, 2.5vw, 1.25rem);
    text-align: center;
    background: var(--card-bg);
  }

  .uploaded-image, .sample-image {
    max-height: clamp(200px, 40vw, 300px);
    width: 100%;
    object-fit: contain;
    cursor: pointer;
    border-radius: var(--border-radius-md);
    transition: all var(--animation-speed) ease;
  }

  .uploaded-image:hover, .sample-image:hover {
    transform: scale(1.05);
  }

  .sample-image {
    border: 2px solid var(--soft-gray);
  }

  .sample-image:hover {
    border-color: var(--primary-navy);
  }

  .alert {
    border-radius: var(--border-radius-lg);
    border: none;
    padding: clamp(1rem, 2.5vw, 1.25rem) clamp(1.25rem, 3vw, 1.5rem);
    margin-bottom: clamp(1rem, 3vw, 1.5rem);
    box-shadow: var(--shadow-card);
    font-size: clamp(0.875rem, 2.5vw, 0.9375rem);
  }

  .alert-warning {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    color: #92400e;
    border-left: 4px solid #f59e0b;
  }

  .alert-success {
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    color: #065f46;
    border-left: 4px solid var(--accent-green);
  }

  .alert-info {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    color: #1e40af;
    border-left: 4px solid #3b82f6;
  }

  .probability-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: clamp(0.875rem, 2vw, 1rem);
    background: var(--soft-gray);
    margin-bottom: 0.5rem;
    border-radius: var(--border-radius-md);
    transition: all var(--animation-speed) ease;
    font-size: clamp(0.875rem, 2.5vw, 0.9375rem);
  }

  .probability-item:hover {
    background: var(--card-bg);
    box-shadow: var(--shadow-card);
    transform: translateX(4px);
  }

  .probability-item.highlighted {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border-left: 4px solid var(--primary-navy);
  }

  /* Loading skeleton for charts */
  .chart-skeleton {
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: var(--border-radius-md);
  }

  @keyframes loading {
    0% {
      background-position: 200% 0;
    }
    100% {
      background-position: -200% 0;
    }
  }

  /* Smooth scrolling */
  html {
    scroll-behavior: smooth;
  }

  /* Touch feedback */
  @media (hover: none) {
    .top-prediction-item:active,
    .collapsible-header:active,
    .action-button:active {
      opacity: 0.7;
    }
  }

  /* Responsive Grid Improvements */
  @media (max-width: 992px) {
    .chart-wrapper {
      min-height: clamp(220px, 35vw, 250px);
    }
    
    .section-card {
      margin-bottom: 1.25rem;
    }
  }

  @media (max-width: 768px) {
    .result-container {
      margin: 0;
      padding: 0;
    }

    .result-header, .result-body {
      border-radius: 0;
    }

    .chart-container {
      margin-bottom: 1.5rem;
    }

    .row.g-3 {
      gap: 0.75rem !important;
    }
  }

  @media (max-width: 576px) {
    .action-button {
      width: 100%;
      max-width: none;
    }

    .severity-badge {
      width: 100%;
      justify-content: center;
    }
  }

  /* Print styles */
  @media print {
    .action-button,
    .collapsible-icon {
      display: none;
    }

    .collapsible-content {
      display: block !important;
      max-height: none !important;
      padding: 1rem !important;
    }

    .section-card,
    .prediction-card {
      break-inside: avoid;
    }
  }

  /* Dark mode support */
  @media (prefers-color-scheme: dark) {
    .chart-skeleton {
      background: linear-gradient(90deg, #2d3748 25%, #1a202c 50%, #2d3748 75%);
    }
  }
</style>

<div class="result-container">
  <div class="result-header">
    <h2>üî¨ Analysis Complete</h2>
    <p>Your skin disease detection results are ready</p>
  </div>

  <div class="result-body">
    <!-- Primary Prediction Card -->
    <div class="prediction-card">
      <div class="prediction-title">Primary Diagnosis</div>
      <div class="disease-name">
        {% if result.is_normal_skin %}
          ‚úÖ {{ result.disease_name }}
        {% else %}
          {{ result.disease_name }}
        {% endif %}
      </div>
      
      <!-- Warning for unreliable predictions -->
      {% if result.is_unreliable %}
      <div class="alert alert-warning">
        <strong>‚ö†Ô∏è Low Confidence Prediction</strong>
        <p class="mb-0" style="margin-top: 0.5rem;">
          {% if result.is_low_confidence %}
            {% widthratio result.confidence 1 100 as confidence_pct_int %}
            The model's confidence is low ({{ confidence_pct_int }}%). This image may not be a valid skin condition, or the model is uncertain.
          {% elif result.is_uncertain %}
            The model is uncertain - multiple diseases have similar probabilities. Please review the "Top 3 Predictions" below.
          {% endif %}
          <br><strong>Recommendation:</strong> If this is not a skin condition image, the prediction may not be accurate. Please upload a clear image of a skin lesion for better results.
        </p>
      </div>
      {% endif %}
      
      <!-- Special message for normal skin -->
      {% if result.is_normal_skin %}
      <div class="alert alert-success">
        <strong>‚úÖ Healthy Skin Detected</strong>
        <p class="mb-0" style="margin-top: 0.5rem;">
          The model detected normal, healthy skin with no apparent abnormalities. If you have concerns about your skin, please consult a dermatologist.
        </p>
      </div>
      {% endif %}
      
      <div class="confidence-section">
        <span class="confidence-label">Confidence Level</span>
        {% widthratio result.confidence 1 100 as confidence_pct %}
        <div class="animated-progress" role="progressbar" aria-valuenow="{{ confidence_pct }}" aria-valuemin="0" aria-valuemax="100">
          <div class="progress-fill {% if result.confidence >= 0.7 %}progress-high{% elif result.confidence >= 0.5 %}progress-medium{% else %}progress-low{% endif %}" 
               style="width: {{ confidence_pct }}%">
            {{ confidence_pct|floatformat:1 }}%
          </div>
        </div>
      </div>

      <div style="margin-top: 1.5rem;">
        <span class="confidence-label">Estimated Severity</span>
        <div>
        {% if result.is_normal_skin %}
        <span class="severity-badge severity-low">
          <span>‚úì</span> No Risk (Healthy)
        </span>
        {% else %}
        <span class="severity-badge {% if result.severity == 'High' %}severity-high{% elif result.severity == 'Medium' %}severity-medium{% else %}severity-low{% endif %}">
          {% if result.severity == 'High' %}‚ö†Ô∏è{% elif result.severity == 'Medium' %}‚ö°{% else %}‚úì{% endif %} {{ result.severity }} Risk
        </span>
        {% endif %}
        </div>
      </div>

      <div class="model-badge">
        <span>{% if result.is_dl_model %}üß†{% else %}ü§ñ{% endif %}</span>
        <span>{% if result.is_dl_model %}Deep Learning{% else %}Machine Learning{% endif %} ¬∑ {{ result.model_type }}</span>
      </div>
    </div>

    <!-- Image Comparison Section -->
    {% if result.uploaded_image_url or result.sample_image_urls %}
    <div class="section-card">
      <div class="section-title">
        <span class="section-icon">üñºÔ∏è</span>
        <span>Image Comparison</span>
      </div>
      <div class="row">
        <!-- Your Uploaded Image -->
        <div class="col-lg-4 mb-4 mb-lg-0">
          <div class="image-card">
            <div class="image-card-header">
              üì§ Your Uploaded Image
            </div>
            <div class="image-card-body">
              {% if result.uploaded_image_url %}
              <img src="{{ result.uploaded_image_url }}" 
                   alt="Uploaded image" 
                   class="uploaded-image"
                   onclick="openImageModal(this.src)"
                   loading="lazy">
              {% else %}
              <p class="text-muted">Image not available</p>
              {% endif %}
            </div>
          </div>
        </div>
        
        <!-- Matched Dataset Samples -->
        <div class="col-lg-8">
          <div class="image-card">
            <div class="image-card-header" style="background: linear-gradient(135deg, var(--accent-green) 0%, #059669 100%);">
              üîç Matched Dataset Samples ({{ result.disease_name }})
            </div>
            <div class="image-card-body">
              {% if result.sample_image_urls %}
              <div class="row g-3">
                {% for sample_url in result.sample_image_urls %}
                <div class="col-md-4 col-6">
                  <div class="text-center">
                    <img src="{{ sample_url }}" 
                         alt="Sample {{ result.disease_name }} image {{ forloop.counter }}" 
                         class="sample-image"
                         onclick="openImageModal(this.src)"
                         loading="lazy">
                    <small class="text-muted d-block mt-2" style="font-weight: 500;">
                      Sample {{ forloop.counter }}
                    </small>
                  </div>
                </div>
                {% endfor %}
              </div>
              <div class="alert alert-info mt-3 mb-0">
                <strong>‚ÑπÔ∏è Note:</strong> These are example images of <strong>{{ result.disease_name }}</strong> from the training dataset. 
                {% if result.is_unreliable %}
                <br><strong>‚ö†Ô∏è Warning:</strong> Due to low confidence, these samples may not match your image. Please verify the prediction is correct.
                {% else %}
                If they look different from your image, check the "Top 3 Predictions" below.
                {% endif %}
              </div>
              {% else %}
              <p class="text-muted text-center">Sample images not available</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Top 3 Predictions -->
    {% if result.top_predictions %}
    <div class="section-card">
      <div class="section-title">
        <span class="section-icon">üìä</span>
        <span>Top 3 Predictions</span>
      </div>
      
      <div class="row">
        <div class="col-lg-5 mb-4 mb-lg-0">
          <div class="chart-container">
            <div class="chart-wrapper">
              <canvas id="pieChart"></canvas>
            </div>
          </div>
        </div>
        
        <div class="col-lg-7">
          {% for pred in result.top_predictions %}
          <div class="top-prediction-item" onclick="highlightPrediction(this)">
            <div style="display: flex; align-items: center; margin-bottom: 0.75rem;">
              <span class="prediction-rank rank-{{ forloop.counter }}">{{ forloop.counter }}</span>
              <span style="font-weight: 600; color: var(--text-primary); flex: 1;">{{ pred.disease }}</span>
              <span style="font-weight: 700; color: var(--primary-navy); font-size: clamp(1rem, 3vw, 1.125rem);">{% widthratio pred.confidence 1 100 %}%</span>
            </div>
            <div class="animated-progress" style="height: 10px;">
              <div class="progress-fill" style="width: {% widthratio pred.confidence 1 100 %}%; background: {% if forloop.counter == 1 %}var(--primary-navy){% elif forloop.counter == 2 %}#06b6d4{% else %}var(--text-secondary){% endif %};"></div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endif %}

    <!-- All Probabilities -->
    {% if result.probabilities %}
    <div class="section-card">
      <div class="section-title">
        <span class="section-icon">üìà</span>
        <span>Complete Probability Distribution</span>
      </div>
      
      <div class="chart-container">
        <div class="chart-wrapper" style="min-height: clamp(350px, 50vw, 400px);">
          <canvas id="barChart"></canvas>
        </div>
      </div>

      <div class="collapsible-section" style="margin-top: 1.5rem;">
        <div class="collapsible-header" onclick="toggleCollapsible(this)">
          <span>View Detailed Probability List</span>
          <span class="collapsible-icon">‚ñº</span>
        </div>
        <div class="collapsible-content">
          {% for cls, prob in result.probabilities.items %}
          {% if forloop.counter <= 10 %}
          <div class="probability-item {% if cls == result.disease_name %}highlighted{% endif %}">
            <span style="font-weight: {% if cls == result.disease_name %}700{% else %}500{% endif %}; color: {% if cls == result.disease_name %}var(--primary-navy){% else %}var(--text-primary){% endif %};">
              {{ cls }}
            </span>
            <span style="font-weight: 600; color: var(--text-secondary);">{% widthratio prob 1 100 %}%</span>
          </div>
          {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Disease Information -->
    {% if result.disease_info %}
    <div class="info-section">
      <div class="info-title">
        <span>‚ÑπÔ∏è</span>
        <span>About {{ result.disease_name }}</span>
      </div>
      
      <div class="info-content">
        <p style="font-weight: 600; margin-bottom: 0.75rem;">Description:</p>
        <p style="margin-bottom: 1.5rem;">{{ result.disease_info.description }}</p>

        <p style="font-weight: 600; margin-bottom: 0.75rem;">üìö Educational Resources:</p>
        <ul class="info-list">
          {% for resource in result.disease_info.resources %}
          <li>{{ resource }}</li>
          {% endfor %}
        </ul>

        <p style="font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.75rem;">üí° General Treatment Approaches:</p>
        <ol class="treatment-list">
          {% for treatment in result.disease_info.treatment_recommendations %}
          <li>{{ treatment }}</li>
          {% endfor %}
        </ol>
      </div>
    </div>

    <div class="warning-box">
      <div class="warning-icon">üë®‚Äç‚öïÔ∏è</div>
      <div class="warning-title">When to Consult a Healthcare Professional</div>
      <div class="warning-text">{{ result.disease_info.consult_doctor }}</div>
    </div>
    {% endif %}

    <!-- Disclaimer -->
    <div class="warning-box" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-color: #ef4444;">
      <div class="warning-icon">‚ö†Ô∏è</div>
      <div class="warning-title" style="color: #7f1d1d;">Important Medical Disclaimer</div>
      <div class="warning-text" style="color: #7f1d1d;">
        This tool is for educational purposes only and should not be used for medical diagnosis or treatment decisions. 
        The predictions are generated by AI models and may not be accurate. Always consult a qualified dermatologist 
        or healthcare professional for proper diagnosis and treatment.
      </div>
    </div>

    <div style="text-align: center; margin-top: 2rem;">
      <a href="{% url 'skindetection:upload' %}" class="action-button">
        <span>üîÑ</span>
        <span>Analyze Another Image</span>
      </a>
    </div>
  </div>
</div>

<!-- Image Modal -->
<div id="imageModal" style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);" onclick="closeImageModal()">
  <span style="position: absolute; top: 20px; right: 35px; color: #fff; font-size: 40px; font-weight: bold; cursor: pointer; transition: 0.3s;" onclick="closeImageModal()">&times;</span>
  <img id="modalImage" style="margin: auto; display: block; max-width: 90%; max-height: 90%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.5);">
</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

{% if result.top_predictions %}
{{ result.top_predictions|json_script:"top-predictions-data" }}
{% endif %}
{% if result.probabilities %}
{{ result.probabilities|json_script:"all-probabilities-data" }}
{% endif %}

<script>
  // Image Modal Functions
  function openImageModal(src) {
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImage');
    modal.style.display = 'block';
    modalImg.src = src;
    document.body.style.overflow = 'hidden';
  }

  function closeImageModal() {
    const modal = document.getElementById('imageModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
  }

  // Close modal on Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeImageModal();
    }
  });

  // Collapsible Function with smooth animation
  function toggleCollapsible(header) {
    const content = header.nextElementSibling;
    const icon = header.querySelector('.collapsible-icon');
    
    if (content.classList.contains('active')) {
      content.classList.remove('active');
      icon.style.transform = 'rotate(0deg)';
    } else {
      content.classList.add('active');
      icon.style.transform = 'rotate(180deg)';
    }
  }

  // Highlight prediction on click
  function highlightPrediction(element) {
    document.querySelectorAll('.top-prediction-item').forEach(item => {
      item.style.background = 'var(--soft-gray)';
    });
    element.style.background = 'var(--card-bg)';
    element.style.boxShadow = 'var(--shadow-card)';
  }

  // Chart data preparation
  let topPredictions = [];
  let allProbabilities = {};
  
  const topPredictionsEl = document.getElementById('top-predictions-data');
  const allProbabilitiesEl = document.getElementById('all-probabilities-data');
  
  if (topPredictionsEl) {
    topPredictions = JSON.parse(topPredictionsEl.textContent);
  }
  if (allProbabilitiesEl) {
    allProbabilities = JSON.parse(allProbabilitiesEl.textContent);
  }
  
  // Chart configuration defaults
  Chart.defaults.font.family = "'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif";
  Chart.defaults.color = '#4b5563';
  Chart.defaults.responsive = true;
  Chart.defaults.maintainAspectRatio = true;
  
  // Pie Chart for Top 3 Predictions
  {% if result.top_predictions %}
  const pieCtx = document.getElementById('pieChart');
  if (pieCtx && topPredictions.length > 0) {
    const pieData = {
      labels: topPredictions.map(p => p.disease),
      datasets: [{
        data: topPredictions.map(p => parseFloat((p.confidence * 100).toFixed(2))),
        backgroundColor: [
          'rgba(30, 41, 59, 0.95)',
          'rgba(6, 182, 212, 0.95)',
          'rgba(107, 114, 128, 0.95)'
        ],
        borderColor: [
          'rgba(30, 41, 59, 1)',
          'rgba(6, 182, 212, 1)',
          'rgba(107, 114, 128, 1)'
        ],
        borderWidth: 2,
        hoverOffset: 8,
        hoverBorderWidth: 3
      }]
    };
    
    new Chart(pieCtx, {
      type: 'doughnut',
      data: pieData,
      options: {
        responsive: true,
        maintainAspectRatio: true,
        cutout: '60%',
        plugins: {
          legend: {
            position: window.innerWidth < 768 ? 'bottom' : 'bottom',
            labels: {
              padding: window.innerWidth < 576 ? 12 : 16,
              font: {
                size: window.innerWidth < 576 ? 11 : 13,
                weight: '600'
              },
              usePointStyle: true,
              pointStyle: 'circle',
              boxWidth: 10,
              boxHeight: 10
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.85)',
            padding: window.innerWidth < 576 ? 10 : 14,
            cornerRadius: 8,
            titleFont: {
              size: window.innerWidth < 576 ? 13 : 15,
              weight: 'bold'
            },
            bodyFont: {
              size: window.innerWidth < 576 ? 12 : 14
            },
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed || 0;
                return ' ' + label + ': ' + value.toFixed(1) + '%';
              }
            }
          }
        },
        animation: {
          animateRotate: true,
          animateScale: true,
          duration: 1200,
          easing: 'easeInOutQuart'
        }
      }
    });
  }
  {% endif %}
  
  // Bar Chart for All Disease Probabilities
  {% if result.probabilities %}
  const barCtx = document.getElementById('barChart');
  if (barCtx && Object.keys(allProbabilities).length > 0) {
    const diseases = Object.keys(allProbabilities);
    const probabilities = Object.values(allProbabilities).map(p => parseFloat((p * 100).toFixed(2)));
    const primaryDisease = '{{ result.disease_name }}';
    
    const backgroundColors = diseases.map(d => 
      d === primaryDisease ? 'rgba(30, 41, 59, 0.9)' : 'rgba(226, 232, 240, 0.8)'
    );
    const borderColors = diseases.map(d => 
      d === primaryDisease ? 'rgba(30, 41, 59, 1)' : 'rgba(203, 213, 225, 1)'
    );
    
    const barData = {
      labels: diseases,
      datasets: [{
        label: 'Confidence (%)',
        data: probabilities,
        backgroundColor: backgroundColors,
        borderColor: borderColors,
        borderWidth: 2,
        borderRadius: 6,
        borderSkipped: false
      }]
    };
    
    new Chart(barCtx, {
      type: 'bar',
      data: barData,
      options: {
        responsive: true,
        maintainAspectRatio: true,
        indexAxis: 'y',
        scales: {
          x: {
            beginAtZero: true,
            max: 100,
            grid: {
              color: 'rgba(0, 0, 0, 0.04)',
              drawBorder: false
            },
            ticks: {
              callback: function(value) {
                return value + '%';
              },
              font: {
                size: window.innerWidth < 576 ? 10 : 12,
                weight: '600'
              },
              padding: window.innerWidth < 576 ? 6 : 8
            },
            title: {
              display: window.innerWidth >= 576,
              text: 'Confidence (%)',
              font: {
                size: 14,
                weight: 'bold'
              },
              padding: 12
            }
          },
          y: {
            grid: {
              display: false,
              drawBorder: false
            },
            ticks: {
              font: {
                size: window.innerWidth < 576 ? 9 : 11,
                weight: '500'
              },
              padding: window.innerWidth < 576 ? 8 : 10
            }
          }
        },
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.85)',
            padding: window.innerWidth < 576 ? 10 : 14,
            cornerRadius: 8,
            titleFont: {
              size: window.innerWidth < 576 ? 12 : 14,
              weight: 'bold'
            },
            bodyFont: {
              size: window.innerWidth < 576 ? 11 : 13
            },
            callbacks: {
              label: function(context) {
                return ' Confidence: ' + context.parsed.x.toFixed(1) + '%';
              }
            }
          }
        },
        animation: {
          duration: 1200,
          easing: 'easeInOutQuart',
          delay: function(context) {
            return context.dataIndex * 30;
          }
        }
      }
    });
  }
  {% endif %}

  // Responsive chart resize handler
  let resizeTimer;
  window.addEventListener('resize', function() {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(function() {
      Chart.instances.forEach(chart => {
        chart.resize();
      });
    }, 250);
  });

  // Add touch feedback for mobile
  if ('ontouchstart' in window) {
    document.querySelectorAll('.top-prediction-item, .collapsible-header, .action-button').forEach(element => {
      element.addEventListener('touchstart', function() {
        this.style.opacity = '0.7';
      });
      element.addEventListener('touchend', function() {
        this.style.opacity = '1';
      });
    });
  }

  // Smooth scroll to sections
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function(e) {
      e.preventDefault();
      const target = document.querySelector(this.getAttribute('href'));
      if (target) {
        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    });
  });

  // Lazy load images on scroll
  if ('IntersectionObserver' in window) {
    const imageObserver = new IntersectionObserver((entries, observer) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const img = entry.target;
          if (img.dataset.src) {
            img.src = img.dataset.src;
            img.removeAttribute('data-src');
          }
          observer.unobserve(img);
        }
      });
    });

    document.querySelectorAll('img[data-src]').forEach(img => {
      imageObserver.observe(img);
    });
  }

  // Add entrance animations on scroll
  const animateOnScroll = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.style.opacity = '1';
        entry.target.style.transform = 'translateY(0)';
      }
    });
  }, { threshold: 0.1 });

  document.querySelectorAll('.section-card').forEach(card => {
    card.style.opacity = '0';
    card.style.transform = 'translateY(20px)';
    card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
    animateOnScroll.observe(card);
  });
</script>
{% endblock %}